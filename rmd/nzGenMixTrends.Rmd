---
title: "NZ generation share trends"
subtitle: "Electricity Authority (EA) data"
author: "Ben Anderson (dataknut@icloud.com)"
date: 'Last run at: `r Sys.time()`'
output: 
  bookdown::html_document2:
    fig_caption: yes
    toc: TRUE
    toc_depth: 4
    toc_float: TRUE
    code_folding: hide
bibliography: '`r path.expand("~/bibliography.bib")`'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE) # but folded by yaml setting

library(dkUtils) # https://github.com/dataknut/dkUtils
# Libraries ----
myLibs <- c("data.table", # fast data munching
            "lubridate", # time stuff
            "flextable", # pretty tables
            "ggplot2", # plots obvs
            "here", # where are we?
            "hms", # more time stuff
            "plotly",
            "viridis"
            )
dkUtils::loadLibraries(myLibs) # load the libs (installs if not present)

# local functions ----
fix_dateTime_axis <- function(plot, breaks = "3 months"){
  plot <- plot + scale_x_datetime(date_labels="%b-%Y", date_breaks = breaks) +
    theme(axis.text.x = element_text(angle = 90, hjust=1)) 
  return(plot)
}

fix_date_axis <- function(plot, breaks = "3 months"){
  plot <- plot + scale_x_date(date_labels="%b-%Y", date_breaks = breaks) +
    theme(axis.text.x = element_text(angle = 90, hjust=1)) 
  return(plot)
}
# project/repo parameters ----
source(here::here("env.R"))

rmdParams <- list()

rmdParams$plotPath <- here::here("rmd", "plots", "nz")

if(!dir.exists(rmdParams$plotPath)){
            dir.create(rmdParams$plotPath)
          }
```

# About

Code copyright (c) `r lubridate::year(now())` the [author](https://www.linkedin.com/in/dataknut/)

License: 
 
 * [CC-BY](https://creativecommons.org/licenses/by/4.0/legalcode)

To cite:

 * Anderson, B, (`r lubridate::year(now())`) New Zealand generation share trends: Electricity Authority data. https://dataknut.github.io/gridCarbon/nzGenMixTrends.html

Code:

 * https://github.com/dataknut/gridCarbon
 
# Introduction

Inspired by https://twitter.com/DrSimEvans/status/1508409309775994892

# Data

This analysis uses the [New Zealand Electricity Authority's Generation](https://www.emi.ea.govt.nz/Wholesale/Datasets/Generation/Generation_MD/) data. 

Values are in kWh per half hour https://www.emi.ea.govt.nz/Wholesale/Datasets/Generation/Generation_MD

As far as we can work out this data does _not_ include distributed (i.e. non-grid connected) generation such as small scale wind, solar, hydro, biomass etc which is connected to the LV network. This means the EA data is likely to _underestimate_ total generation and potentially underestimate the proportion of total generation that is renewable. It is possible that this could be fixed using embedded wind & solar generation data from the [metered embedded generation data](https://www.emi.ea.govt.nz/Wholesale/Datasets/Metered_data/Embedded_generation) although this may still not include household level (micro)generation.

```{r setOlderThan}
rmdParams$olderThan <- 7
```

If the data we have previously downloaded is more than `r rmdParams$olderThan`` days old, re-download.

```{r loadData}

rmdParams$dataPath <- "~/Dropbox/data/NZ_ElecAuth/processed/"

# load all the files we have using rbindlist
# probably ought to do some filtering here
filesToLoad <- list.files(rmdParams$dataPath, pattern = ".csv", 
                          full.names = TRUE)

orig_DT <- rbindlist(lapply(filesToLoad, fread))
setnames(orig_DT, "rDateTime", "dv_dateTime")

message("Original data range from: ", min(orig_DT$dv_dateTime, na.rm = TRUE))
message("...to: ", max(orig_DT$dv_dateTime , na.rm = TRUE))

# make wide for ease of aggregation ----
# sum over fuel code
orig_DT[, kWh := as.numeric(kWh)] # just in case
nzGenMix_wide_dt <- dcast(orig_DT[!is.na(dv_dateTime)], dv_dateTime ~ Fuel_Code, value.var = "kWh", fun.aggregate = sum)

# add derived variables used later ----
addDerivedVars <- function(dt){
  dt[, dv_year := lubridate::year(dv_dateTime)]
dt[, dv_date := lubridate::as_date(dv_dateTime)]
dt[, dv_month := lubridate::month(dv_dateTime)]
dt[, dv_hour := lubridate::hour(dv_dateTime)]
dt[, dv_hms := hms::as_hms(dv_dateTime)]
dt <- gridCarbon::add_season(dt, 
                                 dateVar = "dv_dateTime",
                                 h = "S")
dt <- gridCarbon::add_peakPeriod(dt, 
                                      dateTime = "dv_dateTime")
  return(dt)
}

nzGenMix_wide_dt <- addDerivedVars(nzGenMix_wide_dt)
nzGenMix_dt <- addDerivedVars(orig_DT[!is.na(dv_dateTime)])

#message("Remove incomplete years to avoid weird things in plots.")

message("Filtered data range from: ", min(nzGenMix_wide_dt$dv_dateTime))
message("...to: ", max(nzGenMix_wide_dt$dv_dateTime))

rmdParams$plotCap <- paste0("Data: NZ EA Generation ",
                   min(nzGenMix_wide_dt$dv_date), " - ",
                   max(nzGenMix_wide_dt$dv_date),
                            "\nPlot: @dataknut \nCode: https://github.com/dataknut/gridCarbon")

# > recent date cut ----
recentDateCut <- max(nzGenMix_wide_dt$dv_date - (6*30)) # roughly 6 months

```

>Note:
 
 >* the data _may_ cover more years than we need
 >* the data _may_ contain partial years - BEWARE incomplete years in plots using annual totals or means across all months.

# Recreating DrSimEvans' plot

Inspired by https://twitter.com/DrSimEvans/status/1508409309775994892

> Which explored the relationship between % renewable and fossil-fuel generation for Great Britain (see also https://dataknut.github.io/gridCarbon/gbGenMixTrends.html)

This looks like daily data.

 * Solar + wind (% of gen) vs coal + gas (and % of gen))

```{r simEvansData}
# add together the % and totals we want (half-hourly)

nzGenMix_wide_dt[, dv_total := Coal + Diesel + Gas + Geo + Hydro + Solar + Wind + Wood]
nzGenMix_wide_dt[, dv_coal_gas := Coal + Gas]
nzGenMix_wide_dt[, dv_coal_gas_pc := 100 * dv_coal_gas/dv_total]
nzGenMix_wide_dt[, dv_solar_wind := Solar + Wind]
nzGenMix_wide_dt[, dv_solar_wind_pc := 100 * dv_solar_wind/dv_total]

# keep the vars we want for clarity
temp <- nzGenMix_wide_dt[, .(dv_dateTime, dv_coal_gas, dv_solar_wind,
                    dv_coal_gas_pc, dv_solar_wind_pc, dv_total)]

temp[, dv_date := lubridate::date(dv_dateTime)]

# aggregate to daily data for plotting
plotDT <- temp[,
               .(mean_dv_solar_wind_pc = mean(dv_solar_wind_pc),
                 mean_dv_coal_gas_pc = mean(dv_coal_gas_pc),
                 total_dv_coal_gas = sum(dv_coal_gas),
                 total_dv_solar_wind = sum(dv_solar_wind),
                 total_dv_total = sum(dv_total),
                 nObs = .N), # to check for days with < 48 half hours
               keyby = .(dv_date)
               ]
plotDT[, dv_year := lubridate::year(dv_date)] # for plots
plotDT[, total_dv_coal_gas_pc := 100 * total_dv_coal_gas/total_dv_total] # daily %
plotDT[, total_dv_solar_wind_pc := 100 * total_dv_solar_wind/total_dv_total]

message("Check for days with less than 48 hours - this will be truncated data due to DST breaks. We hate DST breaks")
table(plotDT$nObs)
```

Figure \@ref(fig:meanNZrenewablesVsfossilHalfHourPC) shows the mean half-hourly % generation by each type per day. This is slightly convoluted - it is the mean of the sum of the 48 daily half-hourly values. Unfold the code above for clarity.

The smoothed curves are estimated for each year. The lines terminate at the maximum value for the year. I'm still trying to decide if they tell us anything useful.

```{r meanNZrenewablesVsfossilHalfHourPC, fig.cap="Mean half-hourly % generation by each type per day"}

ggplot2::ggplot(plotDT[dv_year > 2011], aes(x = mean_dv_solar_wind_pc, 
                            y = mean_dv_coal_gas_pc,
                            colour = as.factor(dv_year),
                            alpha = dv_year)) +
  geom_point() +
  geom_smooth() +
  scale_colour_viridis_d(name = "Year") +
  guides(alpha = "none") +
  labs(x = "Solar & wind (mean % of half-hourly generation per day)",
       y = "Coal & gas (mean % of half-hourly generation per day)",
       caption = rmdParams$plotCap)

# save it
ggplot2::ggsave(filename = "meanNZrenewablesVsfossilHalfHourPC.png", 
                path = rmdParams$plotPath,
                height = 5)
```

Figure \@ref(fig:dailyNZpcGenMix) shows the percentage of daily generation by type. This is less convoluted as it is the sum of generation per day for the two categories (solar + wind vs gas + coal) as a % of total daily generation.

Again the smoothed curve is estimated for each year. 

```{r dailyNZpcGenMix, fig.cap="Percentage of daily generation by type"}
ggplot2::ggplot(plotDT[dv_year > 2011], aes(x = total_dv_solar_wind_pc, 
                            y = total_dv_coal_gas_pc,
                            colour = as.factor(dv_year),
                            alpha = dv_year)) +
  geom_point() +
  geom_smooth() +
  scale_colour_viridis_d(name = "Year") +
  guides(alpha = "none") +
  labs(x = "Solar & wind (% of total daily generation)",
       y = "Coal & gas (% of total daily generation)",
       caption = rmdParams$plotCap)

ggplot2::ggsave(filename = "dailyNZpcGenMix.png", 
                path = rmdParams$plotPath,
                height = 5)
```


## Half-hourly versions of the plot

Just cos we can... helpfully split into 'peak' and 'off peak' periods. 

Peak period definitions:

 * Morning 07:00 - 09:00
 * Daytime 09:00 - 16:00
 * Evening 16:00 - 21:00
 * Night - all other times

Again the smoothed curve is estimated for each year (and demand period). 

```{r halfHourlyPCgenByPeakPeriod, fig.cap="Percentage of half-hourly generation by type"}
ggplot2::ggplot(nzGenMix_wide_dt[dv_year > 2011], aes(x = dv_solar_wind_pc, 
                            y = dv_coal_gas_pc,
                            alpha = dv_year,
                            colour = as.factor(dv_year))) +
  geom_point() +
  facet_wrap(. ~ dv_peakPeriod) +
  geom_smooth() +
  scale_colour_viridis_d(name = "Year") +
  guides(alpha = "none") +
  labs(x = "Solar & wind (% of half-hourly generation)",
       y = "Coal & gas (% of half-hourly generation)",
       caption = rmdParams$plotCap)

ggplot2::ggsave(filename = "halfHourlyNZ_PCgenByPeakPeriod.png", 
                path = rmdParams$plotPath,
                height = 5)
```


# Daily generation trends

```{r longTrendsDaily}

plotDT <- nzGenMix_dt[, 
                  .(dailyMWh = sum(as.numeric(kWh/1000))), # MWh -> MWh
                  keyby = .(dv_year, dv_month, dv_date, dv_season, Fuel_Code)]

# annual sum for cross-check 
t <- plotDT[, .(sum_TWh = sum(dailyMWh/1000000),
                nMonths = uniqueN(dv_month)), keyby = .(Year = dv_year)]
t[, Year := as.factor(Year)]

knitr::kable(t, caption = "Total TWh per year for cross-check - beware partial years")

# double check
```


Figure \@ref(fig:dailyGenBySource) shows individual trends for daily generation. Note that the y scale is adapted to each fuel source for clarity of trends.

```{r dailyGenBySource, fig.height = 6, fig.cap = "Trends in daily GWh generation"}
p <- ggplot2::ggplot(plotDT, aes(x = dv_date, y = dailyMWh/1000, colour = Fuel_Code)) +
  geom_line() +
  facet_grid(Fuel_Code ~ ., scales="free_y") +
  scale_color_viridis_d(name = "Source") +
  labs(x = "Date",
       y = "Daily GWh",
       caption = rmdParams$plotCap)

p <- fix_date_axis(p)
p
ggplot2::ggsave(p,
                filename = "dailyNZGenBySource.png", 
                path = rmdParams$plotPath,
                height = 5)
```

Figure \@ref(fig:plotlyDailyGenBySource) is interactive (hover mouse).

```{r plotlyDailyGenBySource, fig.cap="Trends in daily GWh generation"}

plotly::ggplotly(p)

```

Figure \@ref(fig:genTrendStackBySource) stacks them to give a sense of proportion...

```{r genTrendStackBySource, fig.cap = "Trends in daily GWh generation (stacked)"}
p <- ggplot2::ggplot(plotDT, aes(x = dv_date, y = dailyMWh/1000, fill = Fuel_Code)) +
  geom_col(position = "stack") +
  scale_fill_viridis_d(name = "Source") +
  labs(x = "Date",
       y = "Daily GWh",
       caption = rmdParams$plotCap)

p <- fix_date_axis(p)
p
ggplot2::ggsave(p,
                filename = "genNZTrendStackBySource.png", 
                path = rmdParams$plotPath
                )
```

Figure \@ref(fig:genTrendPCBySource) shows the % daily contribution

```{r genTrendPCBySource, fig.cap = "Trends in % daily contribution"}
plotDT[, pcOfDaily := 100 * dailyMWh/sum(dailyMWh), keyby = .(dv_date)]

p <- ggplot2::ggplot(plotDT, aes(x = dv_date, y = round(pcOfDaily,2), colour = Fuel_Code)) +
  geom_line() +
  scale_colour_viridis_d(name = "Source") +
  labs(x = "Date",
       y = "% of total daily GWh",
       caption = rmdParams$plotCap) 

p <- fix_date_axis(p)
p
ggplot2::ggsave(p,
                filename = "genNZTrendPCBySource.png", 
                path = rmdParams$plotPath
                )
```
Figure \@ref(fig:dailyProportionsPlotly) - interactive version

```{r dailyProportionsPlotly, fig.width=8, fig.height=8, fig.cap="Interactive version"}

plotly::ggplotly(p)

```


Figure \@ref(fig:dailyProportionsRecentPlotly) - interactive version

```{r dailyProportionsRecentPlotly, fig.width=8, fig.height=8, fig.cap="Interactive version"}

rp <- ggplot2::ggplot(plotDT[dv_date > recentDateCut], aes(x = dv_date, y = round(pcOfDaily,2), colour = Fuel_Code)) +
  geom_line() +
  scale_colour_viridis_d(name = "Source") +
  labs(x = "Date",
       y = "% of total daily GWh",
       caption = rmdParams$plotCap) 

rp <- fix_date_axis(rp)
rp <- rp +
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")

plotly::ggplotly(rp)

```

# Detailed trends

## Renewable %

Defined how?

Renewable = wind + solar + hydro + geothermal + wood - but note that geothermal is [not necessarily low carbon](https://www.nzgeothermal.org.nz/geothermal-in-nz/what-is-geothermal/).


```{r halfHourlyTilePlotRenewablePC}

nzGenMix_wide_dt[, RENEWABLE := Geo + Hydro + Solar + Wind + Wood]

nzGenMix_wide_dt[, RENEWABLE_perc := 100*RENEWABLE/dv_total]

make_NgesoPlots <- function(dt, 
                            var = "RENEWABLE_perc", # defaults
                            lowColour = "green", 
                            highColour = "red", 
                            scaleLab = "Change me!", 
                            unit_lab = "??",
                            minMax = "max"){
  res <- list() # for the results
  # tile plot ----
  res$tile <- ggplot2::ggplot(dt, aes(x = dv_date, 
                                      y = dv_hms, fill = get(var))) +
    geom_tile() +
    theme(legend.position = "bottom") +
    scale_x_date(date_labels="%b %Y",date_breaks  ="6 months") +
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    scale_fill_continuous(name = paste0(scaleLab, " (", unit_lab, ")"),
                          high = highColour,
                          low = lowColour) +
    labs(x = "Date",
         y = "Half-hour",
         caption = rmdParams$plotCap)
  
  # if(minMax = "max"){
  #   res$tile <- res$tile + 
  #     scale_fill_continuous(name = paste0("Maximum ", scaleLab)
  #                           )
  # }
  #   if(minMax = "min"){
  #   res$tile <- res$tile + 
  #     scale_fill_continuous(name = paste0("Half-hourly ", scaleLab)
  #                           )
  #   }
  
  # line plots ----
  plotDT <- dt[,.(max = max(get(var)),
                  mean = mean(get(var)),
                  min = min(get(var))
  ), keyby = .(dv_date)]
  
  #> mean half-hourly ----
  yLab <- paste0("Mean half-hourly ", scaleLab, " (", unit_lab, ") per day")
  yh <- max(plotDT$mean)
  res$line_mean <- ggplot2::ggplot(plotDT, aes(x = dv_date, 
                                              y = mean, colour = mean)) +
    theme(legend.position = "bottom") +
    scale_x_date(date_labels="%b %Y",date_breaks  ="6 months") +
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    geom_line() +
    scale_color_continuous(name = yLab,
                             high = highColour,
                             low = lowColour) +
    labs(x = "Date",
         y = yLab,
         caption = rmdParams$plotCap) + 
      geom_smooth(aes(y = mean), colour = "grey") +
      geom_hline(yintercept = yh, colour = highColour) +
      annotate("text", x = mean(plotDT$dv_date), 
                      y = yh*1.05, 
               label = paste0("Maximum value: ", round(yh,1), unit_lab))
  
  #> max half-hourly ----
  yLab <- paste0("Maximum half-hourly ", scaleLab, " (", unit_lab, ") per day")
  yh <- max(plotDT$max)
  res$line_max <- ggplot2::ggplot(plotDT, aes(x = dv_date, y = max, colour = max)) +
    theme(legend.position = "bottom") +
    scale_x_date(date_labels="%b %Y",date_breaks  ="6 months") +
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    geom_line() +
    scale_color_continuous(name = yLab,
                             high = highColour,
                             low = lowColour) +
    labs(x = "Date",
         y = yLab,
         caption = rmdParams$plotCap) + 
      geom_smooth(aes(y = max), colour = "grey") +
      geom_hline(yintercept = yh, colour = highColour) +
      annotate("text", x = mean(plotDT$dv_date), 
                      y = yh*1.05, 
               label = paste0("Historical maximum: ", round(yh,1), unit_lab))
     
  #> min half-hourly ----
  yLab <- paste0("Minimum half-hourly ", scaleLab, " (", unit_lab, ") per day")
  yh <- min(plotDT$min)
  res$line_min <- ggplot2::ggplot(plotDT, aes(x = dv_date, y = min, colour = min)) +
    theme(legend.position = "bottom") +
    scale_x_date(date_labels="%b %Y",date_breaks  ="6 months") +
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    geom_line() +
    scale_color_continuous(name = yLab,
                             high = highColour,
                             low = lowColour) +
    labs(x = "Date",
         y = yLab,
         caption = rmdParams$plotCap) + 
      geom_smooth(aes(y = min), colour = "grey") +
      geom_hline(yintercept = yh, colour = highColour) +
      annotate("text", x = mean(plotDT$dv_date), 
                      y = yh*1.05, 
               label = paste0("Historical minimum: ", round(yh,1), unit_lab)
               )
  
  minDateTime <- dt[get(var) == min(plotDT$min), dv_dateTime]
  res$minDateReport <- paste0("Minimum: ", 
                              round(plotDT[min == min(plotDT$min), min],1), unit_lab,
                                    " at ", minDateTime)
  maxDateTime <- dt[get(var) == max(plotDT$max), dv_dateTime]
  res$maxDateReport <- paste0("Maximum: ", 
                              round(plotDT[max == max(plotDT$max), max],1), unit_lab,
                                    " at ", maxDateTime)

  
  return(res)
}

```

### Renewable % (all years)

```{r renewableTile, fig.cap="Half hourly % renewables, all years"}
results <-  make_NgesoPlots(nzGenMix_wide_dt, 
                       var = "RENEWABLE_perc",
                       lowColour = "red",
                       highColour = "green",
                       scaleLab = "Renewable generation",
                       unit = "% of total",
                       minMax = "max" # max line or min line?
)
results$tile
```

```{r renewableMeanLine, fig.cap="Mean half-hourly % renewables per day, all years"}
results$line_mean

```

```{r renewableMaxLine, fig.cap="Maximum half-hourly % renewables per day, all years"}
results$line_max

results$maxDateReport
```

```{r renewableMinLine, fig.cap="Minimum % renewables, all years"}
results$line_min

#results$minDateReport
```

### Renewable % (last 6 months)

```{r renewableTileRecent, fig.cap="% renewables, last 6 months"}
results <-  make_NgesoPlots(nzGenMix_wide_dt[dv_date > recentDateCut], 
                       var = "RENEWABLE_perc",
                       lowColour = "red",
                       highColour = "green",
                       scaleLab = "Renewable generation",
                       minMax = "max",
                       unit_lab = "% of total"
)
results$tile +
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")
```
```{r renewableMeanLineRecent, fig.cap="Mean % renewables, last 6 months"}
results$line_mean +
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")

```

```{r renewableMaxLineRecent, fig.cap="Maximum % renewables, last 6 months"}
results$line_max+
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")

results$maxDateReport
```

```{r renewableMinLineRecent, fig.cap="Minimum % renewables, last 6 months"}
results$line_min +
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")

#results$minDateReport
```


## Wind %

### Wind % (all years)

```{r windTile, fig.cap="% wind, all years"}
nzGenMix_wide_dt[, WIND_perc := 100*Wind/dv_total]
results <-  make_NgesoPlots(nzGenMix_wide_dt, 
                       var = "WIND_perc",
                       lowColour = "red",
                       highColour = "green",
                       scaleLab = "Wind generation",
                       unit = "% of total",
                       minMax = "max" # max line or min line?
)
results$tile
```


```{r windMeanLine, fig.cap="Mean % wind per day, all years"}
results$line_mean

```

```{r windMaxLine, fig.cap="Maximum % wind, all years"}
results$line_max

results$maxDateReport
```

```{r windMinLine, fig.cap="Minimum % wind, all years"}
results$line_min

#results$minDateReport
```

### Wind % (last 6 months)

```{r windTileRecent, fig.cap="% wind, last 6 months"}
results <-  make_NgesoPlots(nzGenMix_wide_dt[dv_date > recentDateCut], 
                       var = "WIND_perc",
                       lowColour = "red",
                       highColour = "green",
                       scaleLab = "Wind generation",
                       minMax = "max",
                       unit_lab = "% of total"
)
results$tile +
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")
```
Figure \@ref(fig:windMeanLineRecent) shows the mean half-hourly % of wind generation per day.

```{r windMeanLineRecent, fig.cap="Mean % wind, last 6 months"}
results$line_mean +
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")

results$maxDateReport
```

```{r windMaxLineRecent, fig.cap="Maximum % wind, last 6 months"}
results$line_max+
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")

results$maxDateReport
```

```{r windMinLineRecent, fig.cap="Minimum % wind, last 6 months"}
results$line_min +
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")

#results$minDateReport
```

## Solar %

### Solar % (all years)

```{r solarTile, fig.cap="% solar, all years"}
nzGenMix_wide_dt[, SOLAR_perc := 100*Solar/dv_total]
results <-  make_NgesoPlots(nzGenMix_wide_dt, 
                       var = "SOLAR_perc",
                       lowColour = "red",
                       highColour = "green",
                       scaleLab = "Solar generation",
                       unit = "%",
                       minMax = "max" # max line or min line?
)
results$tile
```

```{r solarMeanLine, fig.cap="Mean % solar, all years"}
results$line_mean
```


```{r solarMaxLine, fig.cap="Maximum % solar, all years"}
results$line_max

results$maxDateReport
```

```{r solarMinLine, fig.cap="Minimum % solar, all years"}
results$line_min

#results$minDateReport
```

### Solar % (last 6 months)

```{r solarTileRecent, fig.cap="% solar, last 6 months"}
results <-  make_NgesoPlots(nzGenMix_wide_dt[dv_date > recentDateCut], 
                       var = "SOLAR_perc",
                       lowColour = "red",
                       highColour = "green",
                       scaleLab = "Solar generation",
                       minMax = "max",
                       unit_lab = "% of total"
)
results$tile +
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")
```
Figure \@ref(fig:solarMeanLineRecent) shows the mean daily % of generation which is (grid) solar.

```{r solarMeanLineRecent, fig.cap="Mean % solar, last 6 months"}
results$line_mean+
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")

```

```{r solarMaxLineRecent, fig.cap="Maximum % solar, last 6 months"}
results$line_max+
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")

results$maxDateReport
```

```{r solarMinLineRecent, fig.cap="Minimum % solar, last 6 months"}
results$line_min +
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")

#results$minDateReport
```

## Hydro %

### Hydro % (all years)

```{r hydroTile, fig.cap="% solar, all years"}
nzGenMix_wide_dt[, HYDRO_perc := 100*Hydro/dv_total]
results <-  make_NgesoPlots(nzGenMix_wide_dt, 
                       var = "HYDRO_perc",
                       lowColour = "red",
                       highColour = "green",
                       scaleLab = "Hydro generation",
                       unit = "% of total",
                       minMax = "max" # max line or min line?
)
results$tile
```


```{r hydroMeanLine, fig.cap="Mean % hydro, all years"}
results$line_mean

```

```{r hydroMaxLine, fig.cap="Maximum % hydro, all years"}
results$line_max
results$maxDateReport
```

```{r hydroMinLine, fig.cap="Minimum % hydro, all years"}
results$line_min

#results$minDateReport
```

### Hydro % (last 6 months)

```{r hydroTileRecent, fig.cap="% hydro, last 6 months"}
results <-  make_NgesoPlots(nzGenMix_wide_dt[dv_date > recentDateCut], 
                       var = "HYDRO_perc",
                       lowColour = "red",
                       highColour = "green",
                       scaleLab = "Hydro generation",
                       minMax = "max",
                       unit_lab = "% of total"
)
results$tile +
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")
```
```{r hydroMeanLineRecent, fig.cap="Mean % hydro, last 6 months"}
results$line_mean +
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")

```


```{r hydroMaxLineRecent, fig.cap="Maximum % hydro, last 6 months"}
results$line_max+
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")

results$maxDateReport
```

```{r hydroMinLineRecent, fig.cap="Minimum % hydro, last 6 months"}
results$line_min +
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")

#results$minDateReport
```

## Geothermal %


### Geothermal % (all years)

```{r geoTile, fig.cap="% geothermal, all years"}
nzGenMix_wide_dt[, GEO_perc := 100*Geo/dv_total]
results <-  make_NgesoPlots(nzGenMix_wide_dt, 
                       var = "GEO_perc",
                       lowColour = "red",
                       highColour = "green",
                       scaleLab = "Geothermal generation",
                       unit = "%",
                       minMax = "max" # max line or min line?
)
results$tile
```


```{r geoMeanLine, fig.cap="Mean % geothermal, all years"}
results$line_mean
```

```{r geoMaxLine, fig.cap="Maximum % geothermal, all years"}
results$line_max

results$maxDateReport
```

```{r geoMinLine, fig.cap="Minimum % geothermal, all years"}
results$line_min

#results$minDateReport
```

### Geothermal % (last 6 months)

```{r geoTileRecent, fig.cap="% geothermal, last 6 months"}
results <-  make_NgesoPlots(nzGenMix_wide_dt[dv_date > recentDateCut], 
                       var = "GEO_perc",
                       lowColour = "red",
                       highColour = "green",
                       scaleLab = "Geothermal generation",
                       minMax = "max",
                       unit_lab = "% of total"
)
results$tile +
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")
```


```{r geoMeanLineRecent, fig.cap="Mean % geothermal, last 6 months"}
results$line_mean +
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")
```


```{r geoMaxLineRecent, fig.cap="Maximum % geothermal, last 6 months"}
results$line_max+
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")

results$maxDateReport
```

```{r geoMinLineRecent, fig.cap="Minimum % geothermal, last 6 months"}
results$line_min +
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")

#results$minDateReport
```

## Wood %

Wood - potential for growth (biofuels etc, esp if forestry expansion under ETS. Oh.)

### Wood % (all years)

```{r woodTile, fig.cap="% wood, all years"}
nzGenMix_wide_dt[, WOOD_perc := 100*Wood/dv_total]
results <-  make_NgesoPlots(nzGenMix_wide_dt, 
                       var = "WOOD_perc",
                       lowColour = "red",
                       highColour = "green",
                       scaleLab = "Wood generation",
                       unit = "%",
                       minMax = "max" # max line or min line?
)
results$tile
```

```{r woodMeanLine, fig.cap="Mean % wood, all years"}
results$line_mean

```

```{r woodMaxLine, fig.cap="Maximum % wood, all years"}
results$line_max

results$maxDateReport
```

```{r woodMinLine, fig.cap="Minimum % wood, all years"}
results$line_min

#results$minDateReport
```

### Wood % (last 6 months)

```{r woodTileRecent, fig.cap="% wood, last 6 months"}
results <-  make_NgesoPlots(nzGenMix_wide_dt[dv_date > recentDateCut], 
                       var = "WOOD_perc",
                       lowColour = "red",
                       highColour = "green",
                       scaleLab = "Wood generation",
                       minMax = "max",
                       unit_lab = "% of total"
)
results$tile +
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")
```

```{r woodMeanLineRecent, fig.cap="Mean % wood, last 6 months"}
results$line_mean +
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")

```

```{r woodMaxLineRecent, fig.cap="Maximum % wood, last 6 months"}
results$line_max+
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")

results$maxDateReport
```

```{r woodMinLineRecent, fig.cap="Minimum % wood, last 6 months"}
results$line_min +
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")

#results$minDateReport
```

## Gas %


### Gas % (all years)

```{r gasTile, fig.cap="% gas, all years"}
nzGenMix_wide_dt[, GAS_perc := 100*Gas/dv_total]
results <-  make_NgesoPlots(nzGenMix_wide_dt, 
                       var = "GAS_perc",
                       lowColour = "green",
                       highColour = "red",
                       scaleLab = "Gas generation",
                       unit = "%",
                       minMax = "max" # max line or min line?
)
results$tile
```

```{r gasMeanLine, fig.cap="Mean % gas, all years"}
results$line_mean

```

```{r gasMaxLine, fig.cap="Maximum % gas, all years"}
results$line_max

results$maxDateReport
```

```{r gasMinLine, fig.cap="Minimum % gas, all years"}
results$line_min

#results$minDateReport
```

### Gas % (last 6 months)

```{r gasTileRecent, fig.cap="% gas, last 6 months"}
results <-  make_NgesoPlots(nzGenMix_wide_dt[dv_date > recentDateCut], 
                       var = "GAS_perc",
                       lowColour = "green",
                       highColour = "red",
                       scaleLab = "Gas generation",
                       minMax = "max",
                       unit_lab = "% of total"
)
results$tile +
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")
```

```{r gasMeanLineRecent, fig.cap="Mean % gas, last 6 months"}
results$line_mean +
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")

```
```{r gasMaxLineRecent, fig.cap="Maximum % gas, last 6 months"}
results$line_max+
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")

results$maxDateReport
```

```{r gasMinLineRecent, fig.cap="Minimum % gas, last 6 months"}
results$line_min +
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")

#results$minDateReport
```

## Coal %

### Coal % (all years)

```{r coalTile, fig.cap="% coal, all years"}
nzGenMix_wide_dt[, COAL_perc := 100*Coal/dv_total]
results <-  make_NgesoPlots(nzGenMix_wide_dt, 
                       var = "COAL_perc",
                       lowColour = "green",
                       highColour = "red",
                       scaleLab = "Coal generation",
                       unit = "%",
                       minMax = "max" # max line or min line?
)
results$tile+
  scale_x_date(date_labels="%b-%Y")
```

```{r coalMeanLine, fig.cap="Mean % coal, all years"}
results$line_mean +
  scale_x_date(date_labels="%b-%Y")

```

```{r coalMaxLine, fig.cap="Maximum % coal, all years"}
results$line_max+
  scale_x_date(date_labels="%b-%Y")

results$maxDateReport
```

```{r coalMinLine, fig.cap="Minimum % coal, all years"}
results$line_min +
  scale_x_date(date_labels="%b-%Y")

#results$minDateReport
```

### Coal % (last 6 months)

```{r coalTileRecent, fig.cap="% coal, last 6 months"}
results <-  make_NgesoPlots(nzGenMix_wide_dt[dv_date > recentDateCut], 
                       var = "COAL_perc",
                       lowColour = "green",
                       highColour = "red",
                       scaleLab = "Coal generation",
                       minMax = "max",
                       unit_lab = "% of total"
)
results$tile +
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")
```

```{r coalMeanLineRecent, fig.cap="Mean % coal, last 6 months"}
results$line_mean +
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")

```

```{r coalMaxLineRecent, fig.cap="Maximum % coal, last 6 months"}
results$line_max+
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")

results$maxDateReport
```

```{r coalMinLineRecent, fig.cap="Minimum % coal, last 6 months"}
results$line_min +
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")

#results$minDateReport
```


## Diesel %

### Diesel % (all years)

```{r dieselTile, fig.cap="% coal, all years"}
nzGenMix_wide_dt[, DIESEL_perc := 100*Diesel/dv_total]
results <-  make_NgesoPlots(nzGenMix_wide_dt, 
                       var = "DIESEL_perc",
                       lowColour = "green",
                       highColour = "red",
                       scaleLab = "Diesel generation",
                       unit = "%",
                       minMax = "max" # max line or min line?
)
results$tile+
  scale_x_date(date_labels="%b-%Y")
```

```{r dieselMeanLine, fig.cap="Mean % diesel, all years"}
results$line_mean +
  scale_x_date(date_labels="%b-%Y")

```

```{r dieselMaxLine, fig.cap="Maximum % diesel, all years"}
results$line_max+
  scale_x_date(date_labels="%b-%Y")

results$maxDateReport
```

```{r dieselMinLine, fig.cap="Minimum % diesel, all years"}
results$line_min +
  scale_x_date(date_labels="%b-%Y")

#results$minDateReport
```

### Diesel % (last 6 months)

```{r dieselTileRecent, fig.cap="% diesel, last 6 months"}
results <-  make_NgesoPlots(nzGenMix_wide_dt[dv_date > recentDateCut], 
                       var = "DIESEL_perc",
                       lowColour = "green",
                       highColour = "red",
                       scaleLab = "Diesel generation",
                       minMax = "max",
                       unit_lab = "% of total"
)
results$tile +
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")
```

```{r dieselMeanLineRecent, fig.cap="Mean % diesel, last 6 months"}
results$line_mean +
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")

```

```{r dieselMaxLineRecent, fig.cap="Maximum % diesel, last 6 months"}
results$line_max+
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")

results$maxDateReport
```

```{r dieselMinLineRecent, fig.cap="Minimum % diesel, last 6 months"}
results$line_min +
  scale_x_date(date_labels="%b-%Y",date_breaks  ="1 month")

#results$minDateReport
```

## All 'fuels' half-hourly trends

These plots are a denser version of (e.g.) Figure \@ref(fig:dailyGenBySource) because they plot half-hourly %.

```{r allFuelsPcContrib, fig.cap="Half-hourly % contribution by fuel over time (all years)"}
# calculate % contribution in each half hour
# long form data
plotDT <- nzGenMix_dt[, .(GWh = sum(kWh/1000000, na.rm = TRUE)), 
                      keyby = .(Fuel_Code, dv_dateTime)]
plotDT[, pc := 100*GWh/sum(GWh), keyby = .(dv_dateTime)]

p <- ggplot2::ggplot(plotDT,
                aes(x = dv_dateTime,
                    y = pc,
                    colour = Fuel_Code)) +
  geom_line() +
  scale_colour_viridis_d() +
  labs(y = "%",
       x = "Half hour")

fix_dateTime_axis(p)
```

```{r allFuelsPcStackedContribRotated, fig.height=10}
p <- ggplot2::ggplot(plotDT,
                aes(x = dv_dateTime,
                    y = pc,
                    fill = Fuel_Code)) +
  geom_col(position = "stack") +
  scale_fill_viridis_d() +
  labs(y = "%",
       x = "Half hour")

fix_dateTime_axis(p) +
  coord_flip()
```


```{r allFuelsPcContribRecent, fig.cap="Half-hourly % contribution by fuel over time (last 6 months)"}
# calculate % contribution in each half hour
p <- ggplot2::ggplot(plotDT[dv_dateTime > recentDateCut],
                aes(x = dv_dateTime,
                    y = pc,
                    colour = Fuel_Code)) +
  geom_line() +
    scale_colour_viridis_d() +
  labs(y = "%",
       x = "Half hour")

fix_dateTime_axis(p, breaks = "1 month")
```

```{r allFuelsPcStackedContribRotatedRecent, fig.height=10}
p <- ggplot2::ggplot(plotDT[dv_dateTime > recentDateCut],
                aes(x = dv_dateTime,
                    y = pc,
                    fill = Fuel_Code)) +
  geom_col(position = "stack") +
  scale_fill_viridis_d() +
  labs(y = "%",
       x = "Half hour")

fix_dateTime_axis(p, breaks = "1 month") +
  coord_flip()
```

### Hydro vs wind vs grid solar

```{r hydroVsWindvsSolar, fig.cap="Comparison of hydro vs wind vs solar % half-hourly contribution over time (all years)"}
p <- ggplot2::ggplot(plotDT[Fuel_Code == "Wind" | Fuel_Code == "Hydro" |
                              Fuel_Code == "Solar"],
                aes(x = dv_dateTime,
                    y = pc,
                    colour = Fuel_Code)) +
  geom_line(alpha=0.5) +
  geom_smooth() +
  scale_colour_manual(values = c("lightblue", 
                                 "orange", 
                                 "green") # what colour is the wind?!
                      ) +
  labs(y = "% of generation",
       x = "Half hour")
fix_dateTime_axis(p)
```

Figure \@ref(fig:hydroVsWindvsSolarRecent) shows the recent half-hourly % of generation from hydro, wind and grid solar.

```{r hydroVsWindvsSolarRecent, fig.cap="Comparison of hydro vs wind vs solar % half-hourly contribution over time (last 6 months)"}
p <- ggplot2::ggplot(plotDT[dv_dateTime > recentDateCut & (Fuel_Code == "Wind" | Fuel_Code == "Hydro" | Fuel_Code == "Solar")],
                aes(x = dv_dateTime,
                    y = pc,
                    colour = Fuel_Code)) +
  geom_line(alpha=0.5) +
  geom_smooth() +
  scale_colour_manual(values = c("lightblue", 
                                 "orange", 
                                 "green") # what colour is the wind?!
                      ) +
  labs(y = "% of generation",
       x = "Half hour")
fix_dateTime_axis(p, breaks = "1 month")
```

```{r hydroWindRatio, fig.cap="Wind GWh as a % of hydro GWh (all years)"}

nzGenMix_wide_dt[, ratio := WIND_perc/HYDRO_perc]
yMax <- max(nzGenMix_wide_dt$ratio)
p <- ggplot2::ggplot(nzGenMix_wide_dt,
                aes(x = dv_dateTime,
                    y =  100*ratio,
                    colour = dv_season,
                    group = dv_season)) +
  geom_point() +
  geom_hline(yintercept = 100*yMax) +
  annotate("text", x = mean(nzGenMix_wide_dt$dv_dateTime), 
                      y = 100 * yMax*1.05, 
               label = paste0("Maximum: ", 100*round(yMax,2), "%"))+
  labs(y = "Wind GWh as a % of Hydro GWh",
       x = "Half hour")
fix_dateTime_axis(p)
```

```{r hydroWindRatioRecent, fig.cap="Wind GWh as a % of hydro GWh (last 6 months)"}

yMax <- max(nzGenMix_wide_dt[dv_dateTime > recentDateCut]$ratio)
p <- ggplot2::ggplot(nzGenMix_wide_dt[dv_dateTime > recentDateCut],
                aes(x = dv_dateTime,
                    y =  100*ratio,
                    colour = dv_season,
                    group = dv_season)) +
  geom_point() +
  geom_hline(yintercept = 100*yMax) +
  annotate("text", x = mean(nzGenMix_wide_dt[dv_dateTime > recentDateCut]$dv_dateTime), 
                      y = 100 * yMax*1.05, 
               label = paste0("Maximum: ", 100*round(yMax,2), "%"))+
  labs(y = "Wind GWh as a % of Hydro GWh",
       x = "Half hour")
fix_dateTime_axis(p, breaks = "1 month")
```


# Fuel types and time of day 'demand'

Do we see a relationship between generation fuels and peak demand? This will be mediated by the way the electricity market works. 

We may find wind curtailment (not visible here) at low demand periods where geothermal can't be shut off.

First, what is the general average shape of overall generation?

'Peak periods' shown as shaded rectangles

```{r meanGenProfile, fig.cap="Mean half-hourly generation by year and season"}
# orginal values are kWh
plotDT <- nzGenMix_wide_dt[, .(mean_total_GWh = mean(dv_total/1000000),
                               mean_renewables_GWh = mean(RENEWABLE/1000000),
                               mean_renewables_pc = mean(RENEWABLE_perc),
                               mean_hydro_GWh = mean(Hydro/1000000),
                               mean_hydro_pc = mean(HYDRO_perc),
                               mean_coal_GWh = mean(Coal/1000000),
                               mean_coal_pc = mean(COAL_perc),
                               mean_gas_GWh = mean(Gas/1000000),
                               mean_gas_pc = mean(GAS_perc)), keyby = .(dv_hms, dv_year, dv_season, dv_peakPeriod)]

make_profilePlot <- function(dt, yVar = "mean_renewables_GWh", yVarLab = "change me"){
  plotDT <- dt[, .(x = dv_hms, y = get(yVar), alpha = dv_year, 
                   group = dv_year,
                   facet1 = dv_season,
                   colour = dv_peakPeriod)]
  p <- ggplot2::ggplot(plotDT, aes(x = x, 
                                   y = y,
                            alpha = alpha,
                            group = group)) +
    geom_rect(aes(xmin=hms::as_hms("07:00:00"), xmax=hms::as_hms("09:00:00"),
                  ymin=min(plotDT$y), ymax=max(plotDT$y)),
                              fill='pink', alpha=0.1) +
        geom_rect(aes(xmin=hms::as_hms("16:00:00"), xmax=hms::as_hms("21:00:00"),
                  ymin=min(plotDT$y), ymax=max(plotDT$y)),
                              fill='pink', alpha=0.1) +
  geom_line() +
  scale_alpha_continuous(name = "Year") +
  facet_wrap(facet1 ~ .) +
    labs(x = "Time of day",
       y = yVarLab,
       caption = rmdParams$plotCap) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
    scale_x_time(breaks = scales::breaks_width("120 min")) 
  return(p)
}

make_profilePlot(plotDT, "mean_total_GWh", "Mean total (GWh)")

```

Contribution of renewables...

```{r meanRenewablesPC, fig.cap="Mean half-hourly % renewable generation by year and season"}

make_profilePlot(plotDT, "mean_renewables_GWh", "Mean renewables (GWh)")

make_profilePlot(plotDT, "mean_renewables_pc", "Mean % renewables")

```

What is hydro's contribution?

```{r meanHydroPC, fig.cap="Mean half-hourly % hydro generation by year and season"}

make_profilePlot(plotDT, "mean_hydro_GWh", "Mean hydro (GWh)")

make_profilePlot(plotDT, "mean_hydro_pc", "Mean % hydro")

```

What is coal's contribution?

```{r meanCoalPc, fig.cap="Mean half-hourly % coal generation by year and season"}

make_profilePlot(plotDT, "mean_coal_GWh", "Mean coal (GWh)")
make_profilePlot(plotDT, "mean_coal_pc", "Mean % coal")

```

What is gas's contribution?

```{r meanGasPc, fig.cap="Mean half-hourly % gas generation by year and season"}

make_profilePlot(plotDT, "mean_gas_GWh", "Mean gas (GWh")

make_profilePlot(plotDT, "mean_gas_pc", "Mean % gas")
```

Relationship between hydro and overall generation

```{r hydroVsGeneration}
ggplot2::ggplot(nzGenMix_wide_dt, aes(y = Hydro/1000000, x = dv_total/1000000, colour = dv_peakPeriod)) +
  geom_point() +
  facet_grid(dv_year ~ dv_season) +
  labs(y = "Hydro GWh per half hour",
       x = "Total GWh per half hour")
```

YMMV on \@ref(fig:meanRenewablesVsMeanGenSeason)

```{r meanRenewablesVsMeanGenSeason, fig.cap="Mean renewables vs Mean total generation"}
plotDT <- nzGenMix_wide_dt[, .(mean_renewables_GWh = mean(RENEWABLE/1000000),
                 mean_generation_GWh = mean(dv_total/1000000)),
             keyby = .(dv_year, dv_hms, dv_peakPeriod, dv_season)]

ggplot2::ggplot(plotDT, aes(x = mean_generation_GWh , y = mean_renewables_GWh,
                                         colour = dv_peakPeriod)) +
  geom_point() +
  scale_color_discrete(name = "Period") +
  facet_grid(dv_season ~ dv_year) +
  labs(x = "Mean half-hourly generation (GWh)",
       y = "Mean half-hourly renewables (GWh)",
       caption = rmdParams$plotCap)
```

# Summary

That's it. 

You might want to look at recent academic research on this topic:

 * [@staffell_measuring_2017]
 * [@staffell_increasing_2018]

# Annex

## Carbon intensity trends

> XX need to create a half-hourly `CARBON_INTENSITY` variable XX
> Requires:
> * per-fuel CI

Currently: https://environment.govt.nz/assets/publications/Measuring-emissions-guidance-August-2022/Emission-factors-workbook-Measuring-emissions-guidance-August-2022.xlsx 

"The grid-average emission factor best reflects the carbon dioxide equivalent emissions
associated with the generation of a unit of electricity purchased from the national grid in New Zealand in 2020"

"We calculate purchased electricity emission factors on a calendar-year basis and based on the average grid mix of generation types for calendar years. The emission factor accounts for the emissions from fuel combustion at thermal power stations and fugitive emissions from the generation of geothermal electricity. Thermal electricity is generated by burning fossil fuels.

The emission factor for purchased grid-average electricity does not include transmission
and distribution losses. "

"This emission factor also doesn’t reflect the real-world factors that influence the carbon intensity of the grid such as time of year, time of day and geographical area. Therefore, a grid -average emission factor may over or underestimate your organisation’s GHG emissions."

2020 value = 0.120 kg CO2/kWh

Instead use a [model derived from the GB MWh generation mix for 2023](https://dataknut.github.io/gridCarbon/gbGenMixTrends.html#tab:plotEstimates).

Coefficients:

 * Intercept: 41.231171 
 * GAS_perc: 3.571570 
 * COAL_perc: 10.050410
 * WIND_perc: -0.451285
 * HYDRO_perc:  1.147793 # why is hydro +ve?
 * SOLAR_perc: -0.335122
 
This is (obviously) completely broken as HYDRO_perc has a +ve coefficient, the model does not include a coefficient for Geothermal or Wood and the GB mix includes Nuclear, Interconnection and Storage. #YMMV

> Need to fix :-)

But let's imagine it is valid... what would we see?

```{r estimateCarbonIntensity}
# should be annual and fuel specific
# 2020 value

nzGenMix_wide_dt[, CARBON_INTENSITY := 41.231171 +
                   GAS_perc   *  3.571570   + 
                   COAL_perc   * 10.050410   +
                   WIND_perc  * -0.451285  +
                   HYDRO_perc *  1.147793 + # why is hydro +ve?
                   SOLAR_perc * -0.335122]

summary(nzGenMix_wide_dt$CARBON_INTENSITY)
```


### Overall trends

Seasons:

 * Summer: Jun - Aug
 * Autumn: Sept - Nov
 * Winter: Dec - Feb
 * Spring: Mar - May

```{r meanCiTrendBySeason, fig.cap="Mean half-hourly carbon intensity per day"}

plotDT <- nzGenMix_wide_dt[, .(mean_CI = mean(CARBON_INTENSITY)), keyby = .(dv_year, dv_date, dv_season)]

ggplot2::ggplot(plotDT[dv_year > 2011], aes(x = dv_date, y = mean_CI, colour = dv_season)) +
  geom_point() +
  scale_color_viridis_d(name = "Season") +
  theme(legend.position = "bottom") +
  labs(x = "Date",
       y = "Mean g CO2e/kWh",
       caption = rmdParams$plotCap)

ggplot2::ggsave(filename = "meanCiTrendBySeason.png", 
                path = rmdParams$plotPath
                )
```
Re-draw as a boxplot of mean daily CI by month - plotted at month start. \@ref(fig:CIboxplot) shows outliers nicely.

```{r CIboxplot, fig.cap="Mean daily CI boxplots per month"}
plotDT <- nzGenMix_wide_dt[, .(mean_CI = mean(CARBON_INTENSITY)), 
                     keyby = .(dv_year, 
                               dv_date,
                               dv_season)]
plotDT[, dv_month := lubridate::floor_date(dv_date, unit = "months"),]
ggplot2::ggplot(plotDT[dv_year > 2011], aes(x = dv_month, 
                                            y = mean_CI, 
                                            group = dv_month,
                                            colour = dv_season)) +
  geom_boxplot() +
  scale_color_viridis_d(name = "Season") +
  theme(legend.position = "bottom") +
  labs(x = "Month",
       y = "Mean g CO2e/kWh",
       caption = rmdParams$plotCap)

ggplot2::ggsave(filename = "meanCiTrendByMonthSeason.png", 
                path = rmdParams$plotPath
                )
```

Figure \@ref(fig:halfHourlyTilePlotCI) shows half-hourly carbon intensity over time.

```{r halfHourlyTilePlotCI, fig.cap="Half-hourly carbon intensity over time"}
#plotDT <- nzGenMix_wide_dt[, .()]
ci <- make_NgesoPlots(nzGenMix_wide_dt, 
                      var = "CARBON_INTENSITY",
                      lowColour = "green",
                      highColour = "brown",
                      scaleLab = "Carbon intensity (g CO2/MW)",
                      minMax = "min"
)
ci$tile
```


```{r halfHourlyTilePlotCILine}
ci$line
```

```{r halfHourlyTilePlotCIRecent}
ci <- make_NgesoPlots(nzGenMix_wide_dt[dv_year > 2021], 
                      var = "CARBON_INTENSITY",
                      lowColour = "green",
                      highColour = "brown",
                      scaleLab = "Carbon intensity (g CO2/MW)",
                      minMax = "min"
)
ci$tile +
  scale_x_date(date_labels="%b-%Y",date_breaks  ="3 month")


ci$line +
  scale_x_date(date_labels="%b-%Y",date_breaks  ="3 month")
```


### Annual by peak period

Mean carbon intensity per year and season within peak period.

Figure \@ref(fig:annualmeanCIByPeak) suggests evening peak periods still have slightly higher carbon intensity and the shape of the reduction curves differ by season although rather less by period. Interestingly the sustained reduction in carbon intensity in Summer has leveled off.

```{r annualmeanCIByPeak, fig.cap="Mean half-hourly carbon intensity by peak period and season 2012-2022"}
plotDT <- nzGenMix_wide_dt[, .(mean_CI = mean(CARBON_INTENSITY)), keyby = .(dv_year, dv_peakPeriod, dv_season)]

ggplot2::ggplot(plotDT, aes(x = dv_year, y = mean_CI, colour = dv_peakPeriod)) +
  geom_line() +
  scale_color_viridis_d(name = "Peak period") +
  facet_wrap(. ~ dv_season) +
  labs(x = "Year",
       y = "Mean g CO2e/kWh",
       caption = rmdParams$plotCap)

ggplot2::ggsave(filename = "annualMeanCIByPeak.png", 
                path = rmdParams$plotPath
                )
```

## Data descriptors

### NZ generation 'fuel sources'

```{r}
t <- nzGenMix_dt[, .(TWh = sum(kWh/1000000000)), keyby =.(Fuel_Code, Tech_Code)]

dct <- dcast(t, Fuel_Code ~ Tech_Code)
knitr::kable(dct, digits = 3, caption = "Fuel codes by technology code (total TWh in dataset)")
```
### NZ annual generation % by fuel code

Table \@ref(tab:annualGenByFuelCode) shows annual GWh and % GWh by fuel code.

```{r annualGenByFuelCode}

t <- nzGenMix_dt[, .(GWh = sum(kWh/1000000), na.rm = TRUE),
                 keyby = .(dv_year, Fuel_Code)]
t[, GWh_pc := 100*GWh/sum(GWh), keyby = .(dv_year)]

dct <- dcast(t, dv_year ~ Fuel_Code, value.var = "GWh")
knitr::kable(dct, digits = 2,
             caption = "GWh per year by Fuel Code - beware incomplete years")

dct <- dcast(t, dv_year ~ Fuel_Code, value.var = "GWh_pc")
knitr::kable(dct, digits = 1,
             caption = "% GWh per year by Fuel Code - beware incomplete years")
```

### NZ gen mix data

```{r skimNZGen}
skimr::skim(nzGenMix_wide_dt)
```

## R environment

Packages etc:

 * base R [@baseR]
 * bookdown [@bookdown]
 * data.table [@data.table]
 * ggplot2 [@ggplot2]
 * here [@here]
 * hms [@hms]
 * knitr [@knitr]
 * lubridate [@lubridate]
 * rmarkdown [@rmarkdown]

# References
